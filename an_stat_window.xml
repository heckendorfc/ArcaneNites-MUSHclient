<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>

<muclient>
<plugin
   name="Arcane_Nites_Stats_Window"
   author="Merbie"
   id="bb5299ab4b2bcb8009707689"
   language="Lua"
   purpose="Displays stats in a window"
   date_written="2014-01-14 12:00:00"
   requires="4.34"
   version="1.0"
   save_state="y"
   >
<description trim="y">
<![CDATA[
]]>
</description>

</plugin>


<!--  Triggers  -->

<!--  Script  -->


<script>
<![CDATA[

require "commas"

background_colour = 0xE7FFFF
text_colour = 0x000000
heading_colour = 0x800080
time_colour = 0x82004B

function OnPluginTelnetRequest (type, data)
	if type == MSDP and data == "WILL" then
		using_msdp = true
		return true
	elseif type == MSDP and data == "SENT_DO" then
		-- IAC SB MSDP response IAC SE 
		-- SendPkt ("\255\250\69\1REPORT\2CHARACTER_NAME\2SUBCLASS\2SHAPECHANGE\2HEALTH_MAX\2HEALTH\2MANA_MAX\2MANA\2MOVEMENT_MAX\2MOVEMENT\2PRIMAL_CAP\2PRIMAL_SAFE\2PRIMAL\2TRAIN_POWER\2TRAIN_STAT\2TIMER_ADRENALINE\2TIMER_BLUR\2TIMER_REGEN\2LOCATION\2LOCATION_X\2LOCATION_Y\2LOCATION_MAP\2LOCATION_TERRAIN\2LOCATION_NEARBY\2LOCATION_AVATARS\2WORLD_TIME\2WORLD_SUNRISE\2MOUNT\2TARGET\2TARGET_AVATAR\2TARGET_HEALTH\2TARGET_DIRECTION\2TARGET_DISTANCE\2TARGET_AGE\2TARGET_VALID\2TARGET_X\2TARGET_Y\2LOCATION_FACING\2MOVE_POSITION\2MOVE_RATE\2AFFECTS\255\240")
		SendPkt ("\255\250\69\1REPORT\2HITROLL\2DAMROLL\2SAVES\2AC\2STR\2INT\2WIS\2CON\2DEX\2CHA\255\240")
		return true
	else -- another protocol
		return false
	end -- if
end -- function OnPluginTelnetRequest

function OnPluginTelnetSubnegotiation (type, data)
if type == MSDP then
endpos = string.len(data)
bName = false
bValue = false
bTable = false
bIgnore = false
variable = nil
value = nil

--Note('Raw data: ['..data..']')

for i=1,endpos,1 do
if string.byte(data,i) == 1 and bTable == false then
if variable ~= nil and value ~= nil then
StoreVariable(variable, value)
variable = nil
value = nil
end -- if
bName = true
bValue = false
elseif string.byte(data,i) == 2 and bTable == false then
if value ~= nil then
value = value.." "
end -- if
bName = false
bValue = true
elseif string.byte(data,i) == 3 then
bTable = true
bIgnore = true
elseif string.byte(data,i) == 4 then
bTable = false
elseif bIgnore == true then
bIgnore = false -- Just ignore one character.
elseif bName == true then
if variable == nil then
variable = ""
end -- if
variable = variable..string.sub(data,i,i)
elseif bValue == true then
if value == nil then
value = ""
end -- if
value = value..string.sub(data,i,i)
end -- if
end -- for

if variable ~= nil then
if value == nil then
value = ""
end -- if
StoreVariable(variable, value)
end -- if

-- redraw the energy bars
show_stats()

end -- if
end -- function OnPluginTelnetSubnegotiation

function StoreVariable (MSDP_var, MSDP_val)
	--Note('Variable: '..MSDP_var..' = '..MSDP_val)
	if MSDP_var == "SERVER_ID" then
		show_stats()
		SendPkt ("\255\250\69\1PLUGIN_ID\2GW2 MUSHclient plugin (version 1.14)\255\240")
	elseif MSDP_var == "HOTKEY" then
		msdp[MSDP_var] = MSDP_val
		-- update_hotkeys ()
	else -- store the variable
		msdp[MSDP_var] = MSDP_val
		show_stats()
	end -- if
end -- function StoreVariable

function Display_Line (i, text, id, colour)

  local left = 5
  local top =  (i * font_height) - font_height

  WindowText (win, id, text, left, top, 0, 0, colour)

end -- Display_Line

function show_stats()
  if #msdp == 0 then
    return
  end -- if

  local keyset={}
  local n=0

  for k,v in pairs(msdp) do
    n=n+1
    keyset[n]=k
  end

  -- recreate the window the correct size
  check (WindowCreate (win, 
                 0, 0,   -- left, top (auto-positions)
                 max_width + 10,     -- width
                 (#msdp + 2)   * font_height + 5,  -- height
                 7,       -- auto-position: top middle
                 0,  -- flags
                 0xE7FFFF) )
 
  for i=1, #msdp do
    line = string.format("%s: %s",keyset[i],msdp[keyset[i]])
    Display_Line (i, line, font_id, text_colour)
  end

  WindowShow (win, true)  
end

function OnPluginInstall ()
  max_width = 20
  win = GetPluginID ()
  font_id = "fn"
  
  font_name = "Comic Sans MS"    -- the actual font
  
  -- make window so I can grab the font info
  check (WindowCreate (win, 
                 0, 0, 1, 1,  
                 1,   -- irrelevant
                 0, 
                 background_colour) )

  check (WindowFont (win, font_id, font_name, 8, false, false, false, false, 0, 0))  -- normal  
  font_height = WindowFontInfo (win, font_id, 1)  -- height
end -- OnPluginInstall

function OnPluginDisable ()
  WindowShow (win, false)
end -- OnPluginDisable

]]>
</script>

</muclient>
