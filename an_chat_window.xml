<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>

<muclient>
<plugin
   name="Arcane_Nites_Chat_Logger"
   author="Merbie"
   id="cf3c0748753d37f3e9832fc3"
   language="Lua"
   purpose="Displays channel messages in a window"
   date_written="2014-01-14 12:00:00"
   requires="4.34"
   version="1.0"
   save_state="y"
   >
<description trim="y">
<![CDATA[
]]>
</description>

</plugin>


<!--  Triggers  -->

<triggers>
  <trigger
   match=".*? tells you '.*"
   name="tell_line"
   script="tell_line"
   sequence="100"
  >
  </trigger>

  <trigger
   match=".*? says '.*"
   name="say_line"
   script="say_line"
   sequence="100"
  >
  </trigger>
  <trigger
   match=".*? shrieks '.*"
   name="shriek_line"
   script="shriek_line"
   sequence="100"
  >
  </trigger>
  <trigger
   match=".*? OOCs '.*"
   name="ooc_line"
   script="ooc_line"
   sequence="100"
  >
  </trigger>
  <trigger
   match=".*? tells the group '.*"
   name="gtell_line"
   script="gtell_line"
   sequence="100"
  >
  </trigger>
  <trigger
   match="\1B[0;37m.*?> .*"
   name="hero_line"
   script="hero_line"
   sequence="100"
  >
  </trigger>
</triggers>

<!--  Timers  -->


<!--  Script  -->


<script>
<![CDATA[

require "commas"

background_colour = 0xE7FFFF
text_colour = 0x000000
heading_colour = 0x800080
time_colour = 0x82004B

chat_log = {}
chat_log_index = 1
num_log_lines = 7
 
function add_chat_line (line)
  chat_log[chat_log_index] = line

  chat_log_index = chat_log_index + 1
  if chat_log_index >= num_log_lines then
    chat_log_index = 1
  end

  max_width = math.max (max_width, WindowTextWidth (win, font_id, line))
end -- add_chat_line

function Display_Line (i, text, id, colour)

local left = 5
local top =  (i * font_height) - font_height

  WindowText (win, id, text, left, top, 0, 0, colour)

end -- Display_Line

function show_chat_log ()

  -- do nothing if nothing in the log
  if #chat_log == 0 then
    return
  end -- if

  -- recreate the window the correct size
  check (WindowCreate (win, 
                 0, 0,   -- left, top (auto-positions)
                 max_width + 10,     -- width
                 (#chat_log + 2)   * font_height + 5,  -- height
                 7,       -- auto-position: top middle
                 0,  -- flags
                 0xE7FFFF) )
 
  for i=1, #chat_log do
    Display_Line (i, chat_log[1+(chat_log_index+i)%num_log_lines], font_id, text_colour)
  end

  WindowShow (win, true)  
end -- show_campaign_text

function tell_line (name, line, wildcards)
	add_chat_line(line)
end

function say_line (name, line, wildcards)
	add_chat_line(line)
end

function shriek_line (name, line, wildcards)
	add_chat_line(line)
end

function hero_line (name, line, wildcards)
	add_chat_line(line)
end

function gtell_line (name, line, wildcards)
	add_chat_line(line)
end

function ooc_line (name, line, wildcards)
	add_chat_line(line)
end

function OnPluginInstall ()
  
  win = GetPluginID ()
  font_id = "fn"
  
  font_name = "Comic Sans MS"    -- the actual font
  
  -- make window so I can grab the font info
  check (WindowCreate (win, 
                 0, 0, 1, 1,  
                 1,   -- irrelevant
                 0, 
                 background_colour) )

  check (WindowFont (win, font_id, font_name, 8, false, false, false, false, 0, 0))  -- normal  
  font_height = WindowFontInfo (win, font_id, 1)  -- height

  for i=1, num_log_lines do
    chat_log[i] = ""
  end
end -- OnPluginInstall

function OnPluginDisable ()
  WindowShow (win, false)
end -- OnPluginDisable

]]>
</script>

</muclient>
